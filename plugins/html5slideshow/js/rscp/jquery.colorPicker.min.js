(function(d){var e,b,a=0,g={control:d('<div class="colorPicker-picker">&nbsp;</div>'),palette:d('<div id="colorPicker_palette" class="colorPicker-palette" />'),swatch:d('<div class="colorPicker-swatch">&nbsp;</div>'),hexLabel:d('<label for="colorPicker_hex">Hex</label>'),hexField:d('<input type="text" id="colorPicker_hex" />')},h="transparent",c,i="onColorChange",f="background-color";d.fn.colorPicker=function(j){return this.each(function(){var o=d(this),k=d.extend({},d.fn.colorPicker.defaults,j),l=d.fn.colorPicker.toHex((o.val().length>0)?o.val():k.pickerDefault),s=g.control.clone(),n=g.palette.clone().attr("id","colorPicker_palette-"+a),r=g.hexLabel.clone(),p=g.hexField.clone(),q=n[0].id,t,m;d(s)[0].prevCB=k.prevCB;d.each(k.colors,function(u){t=g.swatch.clone();if(k.colors[u]===h){t.addClass(h).text("X");d.fn.colorPicker.bindPalette(p,t,h)}else{t.css(f,"#"+this);d.fn.colorPicker.bindPalette(p,t)}t.appendTo(n)});r.attr("for","colorPicker_hex-"+a);p.attr({id:"colorPicker_hex-"+a,value:l});p.bind("keydown",function(v){if(v.keyCode===13){var u=d.fn.colorPicker.toHex(d(this).val());d.fn.colorPicker.changeColor(u?u:o.val())}if(v.keyCode===27){d.fn.colorPicker.hidePalette()}});p.bind("keyup",function(v){var u=d.fn.colorPicker.toHex(d(v.target).val());d.fn.colorPicker.previewColor(u?u:d(v.target).val())});d('<div class="colorPicker_hexWrap" />').append(r).appendTo(n);n.find(".colorPicker_hexWrap").append(p);if(k.showHexField===false){p.hide();r.hide()}d("body").append(n);n.hide();s.css(f,l);s.bind("click",function(){if(o.is(":not(:disabled)")){d.fn.colorPicker.togglePalette(d("#"+q),d(this))}});if(j&&j.onColorChange){s.data(i,j.onColorChange)}else{s.data(i,function(){})}if(m=o.attr("data-text")){s.html(m)}o.after(s);o.bind("change",function(){o.next(".colorPicker-picker").css(f,d.fn.colorPicker.toHex(d(this).val()))});o.val(l);if(o[0].tagName.toLowerCase()==="input"){o.each(function(){this.type="hidden"})}else{o.hide()}a++})};d.extend(true,d.fn.colorPicker,{toHex:function(k){if(k.match(/[0-9A-F]{6}|[0-9A-F]{3}$/i)){return(k.charAt(0)==="#")?k:("#"+k)}else{if(k.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/)){var o=([parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)]),n=function(r){if(r.length<2){for(var q=0,p=2-r.length;q<p;q++){r="0"+r}}return r};if(o.length===3){var m=n(o[0].toString(16)),l=n(o[1].toString(16)),j=n(o[2].toString(16));return"#"+m+l+j}}else{return false}}},checkMouse:function(l,k){var j=b,m=d(l.target).parents("#"+j.attr("id")).length;if(l.target===d(j)[0]||l.target===e[0]||m>0){return}d.fn.colorPicker.hidePalette()},hidePalette:function(){d(document).unbind("mousedown",d.fn.colorPicker.checkMouse);d(".colorPicker-palette").hide()},showPalette:function(j){var k=e.prev("input").val();j.css({top:e.offset().top+(e.outerHeight()),left:e.offset().left-j.width()});d("#color_value").val(k);j.show();d(document).bind("mousedown",d.fn.colorPicker.checkMouse)},togglePalette:function(j,k){if(k){e=k}b=j;if(b.is(":visible")){d.fn.colorPicker.hidePalette()}else{d.fn.colorPicker.showPalette(j)}},changeColor:function(j){e.css(f,j);e.prev("input").val(j).change();d.fn.colorPicker.hidePalette();e.data(i).call(e,d(e).prev("input").attr("id"),j)},previewColor:function(j){e.css(f,j);d(e)[0].prevCB(j)},bindPalette:function(l,k,j){j=j?j:d.fn.colorPicker.toHex(k.css(f));k.bind("click",function(m){c=j;d.fn.colorPicker.changeColor(j)});k.bind("mouseover",function(m){c=l.val();d(this).css("border-color","#598FEF");l.val(j);d.fn.colorPicker.previewColor(j)});k.bind("mouseout",function(m){d(this).css("border-color","#000");l.val(e.css(f));l.val(c);d.fn.colorPicker.previewColor(c)})}});d.fn.colorPicker.defaults={pickerDefault:"FFFFFF",colors:["000000","993300","333300","000080","333399","333333","800000","FF6600","808000","008000","008080","0000FF","666699","808080","FF0000","FF9900","99CC00","339966","33CCCC","3366FF","800080","999999","FF00FF","FFCC00","FFFF00","00FF00","00FFFF","00CCFF","993366","C0C0C0","FF99CC","FFCC99","FFFF99","CCFFFF","99CCFF","FFFFFF"],addColors:[],prevCB:function(j){},showHexField:true}})(jQuery);